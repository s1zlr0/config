import yaml
import sys
import urllib.request
import urllib.error
import xml.etree.ElementTree as ET
import ssl

ssl_context = ssl.create_default_context()
ssl_context.check_hostname = False
ssl_context.verify_mode = ssl.CERT_NONE

class MavenDependencyAnalyzer:
    def __init__(self, config):
        self.config = config
        
    def load_config(self):
        try:
            with open('config.yaml', 'r') as file:
                config = yaml.safe_load(file)
                if config is None:
                    raise Exception("config.yaml пустой")
                return config
        except FileNotFoundError:
            raise Exception("Файл config.yaml не найден")
        except yaml.YAMLError as e:
            raise Exception(f"Ошибка в формате YAML: {e}")
    
    def validate_config(self, config) -> bool:
        required_fields = {
            'package_name': str,
            'repository_url': str,
            'test_mode': bool,
            'ascii_tree': bool,
            'max_depth': int
        }
        
        for field, field_type in required_fields.items():
            if field not in config:
                raise Exception(f"Отсутствует обязательное поле '{field}'")
            
            if not isinstance(config[field], field_type):
                raise Exception(f"Поле '{field}' должно быть типа {field_type.__name__}")
        
        if config['max_depth'] < 1:
            raise Exception("max_depth должен быть целым числом больше 0")
        
        if not config['package_name'].strip():
            raise Exception("package_name не может быть пустым")
        
        if ':' not in config['package_name']:
            raise Exception("package_name должен быть в формате 'group:artifact'")
        
        return True
    
    def get_dependencies(self):
        package_name = self.config['package_name']
        
        if self.config['test_mode']:
            return self._get_test_dependencies(package_name)
        else:
            return self._get_real_dependencies(package_name)
    
    def _get_test_dependencies(self, package_name: str):
        test_data = {
            "org.springframework:spring-core": [
                "org.springframework:spring-jcl",
                "commons-logging:commons-logging"
            ],
            "org.apache.commons:commons-lang3": [
                "org.apache.commons:commons-parent",
                "junit:junit"
            ],
            "com.google.guava:guava": [
                "com.google.guava:guava-parent",
                "com.google.code.findbugs:jsr305"
            ]
        }
        return test_data.get(package_name, [])
    
    def _get_real_dependencies(self, package_name: str):
        try:
            group_id, artifact_id = package_name.split(':', 1)
            base_url = self.config['repository_url'].rstrip('/')
            
            print(f"Анализируем пакет: {package_name}")
            print(f"Репозиторий: {base_url}")
            metadata_url = f"{base_url}/{group_id.replace('.', '/')}/{artifact_id}/maven-metadata.xml"
            print("Загружаем metadata")
            with urllib.request.urlopen(metadata_url, context=ssl_context) as response:
                metadata_content = response.read().decode('utf-8')
            version = self._parse_latest_version(metadata_content)
            if not version:
                raise Exception(f"Не удалось найти версию для пакета {package_name}")
            
            print(f"Найдена версия: {version}")
            pom_url = f"{base_url}/{group_id.replace('.', '/')}/{artifact_id}/{version}/{artifact_id}-{version}.pom"
            print("Загружаем POM файл")
            
            with urllib.request.urlopen(pom_url, context=ssl_context) as response:
                pom_content = response.read().decode('utf-8')
            dependencies = self._parse_pom_dependencies(pom_content)
            print(f"Найдено зависимостей: {len(dependencies)}")
            
            return dependencies
            
        except urllib.error.URLError as e:
            raise Exception(f"Ошибка сети: {e}")
        except Exception as e:
            raise Exception(f"Ошибка при получении зависимостей: {e}")
    
    def _parse_latest_version(self, metadata_content: str) -> str:
        try:
            root = ET.fromstring(metadata_content)
            versioning = root.find('versioning')
            if versioning is not None:
                latest = versioning.find('latest')
                if latest is not None:
                    return latest.text
            versions = root.find('versioning/versions')
            if versions is not None and len(versions) > 0:
                return versions[0].text
            
            return ""
            
        except Exception as e:
            raise Exception(f"Ошибка парсинга metadata: {e}")
    
    def _parse_pom_dependencies(self, pom_content: str):
        try:
            root = ET.fromstring(pom_content)
            dependencies = []
            ns = {'maven': 'http://maven.apache.org/POM/4.0.0'}
            
            for dep in root.findall('.//maven:dependency', ns):
                group_id_elem = dep.find('maven:groupId', ns)
                artifact_id_elem = dep.find('maven:artifactId', ns)
                
                if group_id_elem is not None and artifact_id_elem is not None:
                    dependency_str = f"{group_id_elem.text}:{artifact_id_elem.text}"
                    dependencies.append(dependency_str)
            
            return dependencies
            
        except Exception as e:
            raise Exception(f"Ошибка парсинга POM: {e}")
    
    def run(self):
        try:
            print("Анализатор зависимостей Maven")
            
            config = self.load_config()
            self.validate_config(config)
            self.config = config
            
            print(f"\nАНАЛИЗ ЗАВИСИМОСТЕЙ:")
            
            dependencies = self.get_dependencies()
            
            print(f"\nПРЯМЫЕ ЗАВИСИМОСТИ ПАКЕТА '{config['package_name']}':")
            
            if dependencies:
                for i, dep in enumerate(dependencies, 1):
                    print(f"{i}. {dep}")
            else:
                print("Зависимости не найдены")
            
            
        except KeyboardInterrupt:
            print("\nПрограмма прервана пользователем")
            sys.exit(1)
        except Exception as e:
            print(f"Ошибка: {e}")
            sys.exit(1)

def main():
    analyzer = MavenDependencyAnalyzer({})
    analyzer.run()

if __name__ == "__main__":
    main()
